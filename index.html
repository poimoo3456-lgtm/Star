<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>р╕гр╕░р╕Ър╕Ър╣Ар╕Кр╣Зр╕Бр╕Кр╕╖р╣Ир╕н QR</title>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h2>р╕гр╕░р╕Ър╕Ър╣Ар╕Кр╣Зр╕Бр╕Кр╕╖р╣Ир╕н</h2>

<button onclick="showLogin('admin')">ЁЯЫа Admin</button>
<button onclick="showLogin('teacher')">ЁЯСитАНЁЯПл р╕Др╕гр╕╣</button>
<button onclick="show('student')">ЁЯСйтАНЁЯОУ р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ</button>

<hr>

<!-- ========== LOGIN ========== -->
<div id="login" style="display:none">
<h3 id="loginTitle"></h3>
<input id="loginUser" placeholder="р╕Кр╕╖р╣Ир╕нр╕Др╕гр╕╣ (р╣Ар╕Йр╕Юр╕▓р╕░р╕Др╕гр╕╣)">
<input id="loginPass" placeholder="р╕гр╕лр╕▒р╕кр╕Ьр╣Ир╕▓р╕Щ" type="password">
<button onclick="login()">р╣Ар╕Вр╣Йр╕▓р╕кр╕╣р╣Ир╕гр╕░р╕Ър╕Ъ</button>
<p id="loginMsg"></p>
</div>

<!-- ========== ADMIN ========== -->
<div id="admin" style="display:none">
<h3>р╕гр╕░р╕Ър╕Ър╕лр╕ер╕▒р╕Зр╕Ър╣Йр╕▓р╕Щ</h3>

<h4>р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕гр╕лр╕▒р╕к Admin</h4>
<input id="newAdminPass" placeholder="р╕гр╕лр╕▒р╕кр╣Гр╕лр╕бр╣И">
<button onclick="changeAdminPass()">р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ</button>

<h4>р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕гр╕╣</h4>
<input id="teacherName" placeholder="р╕Кр╕╖р╣Ир╕нр╕Др╕гр╕╣">
<input id="teacherPass" placeholder="р╕гр╕лр╕▒р╕кр╕Др╕гр╕╣">
<button onclick="addTeacher()">р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕гр╕╣</button>

<h4>р╣Ар╕Юр╕┤р╣Ир╕бр╕зр╕┤р╕Кр╕▓</h4>
<input id="subjectName" placeholder="р╕Кр╕╖р╣Ир╕нр╕зр╕┤р╕Кр╕▓">
<button onclick="addSubject()">р╣Ар╕Юр╕┤р╣Ир╕бр╕зр╕┤р╕Кр╕▓</button>

<button onclick="openSystem()">р╣Ар╕Ыр╕┤р╕Фр╕гр╕░р╕Ър╕Ъ</button>
<button onclick="closeSystem()">р╕Ыр╕┤р╕Фр╕гр╕░р╕Ър╕Ъ</button>

<p id="adminMsg"></p>
</div>

<!-- ========== TEACHER ========== -->
<div id="teacher" style="display:none">
<h3>р╕гр╕░р╕Ър╕Ър╕Др╕гр╕╣</h3>

<select id="subjectSelect"></select><br><br>

<button onclick="createQR('р╕бр╕▓')">р╕кр╕гр╣Йр╕▓р╕З QR</button>
<button onclick="createQR('р╕кр╕▓р╕в')">р╣Ар╕Ыр╕┤р╕Фр╕кр╕▓р╕в</button>

<pre id="qrResult"></pre>

<h4>р╕гр╕▓р╕вр╕Зр╕▓р╕Щр╣Ар╕Вр╣Йр╕▓р╣Ар╕гр╕╡р╕вр╕Щ</h4>
<button onclick="loadReport()">р╣Вр╕лр╕ер╕Фр╕гр╕▓р╕вр╕Зр╕▓р╕Щ</button>
<ul id="report"></ul>
</div>

<!-- ========== STUDENT ========== -->
<div id="student" style="display:none">
<h3>р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ</h3>
<input id="studentId" placeholder="р╣Ар╕ер╕Вр╕Ыр╕гр╕░р╕Ир╕│р╕Хр╕▒р╕зр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ"><br><br>
<div id="reader" style="width:300px"></div>
<p id="studentMsg"></p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc,
  getDoc, getDocs, setDoc, query, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const app = initializeApp({
  apiKey: "AIzaSyD19ffZKxxXfWj9sseK66LCCVEWqGNqPPI",
  authDomain: "appsk-7f523.firebaseapp.com",
  projectId: "appsk-7f523"
});
const db = getFirestore(app);

let currentTeacher = null;
let loginRole = null;

/* UI */
window.show = id => {
  ["login","admin","teacher","student"].forEach(d =>
    document.getElementById(d).style.display="none");
  document.getElementById(id).style.display="block";
};

window.showLogin = role => {
  loginRole = role;
  show("login");
  loginTitle.innerText = role === "admin" ? "Admin Login" : "р╕Др╕гр╕╣ Login";
  loginUser.style.display = role === "teacher" ? "block" : "none";
};

/* LOGIN */
window.login = async () => {
  if(loginRole==="admin"){
    const snap = await getDoc(doc(db,"config","admin"));
    if(loginPass.value === snap.data().password){
      show("admin");
    } else loginMsg.innerText="р╕гр╕лр╕▒р╕кр╕Ьр╕┤р╕Ф";
  }

  if(loginRole==="teacher"){
    const q = query(collection(db,"teachers"),
      where("name","==",loginUser.value));
    const snap = await getDocs(q);
    if(snap.empty) return loginMsg.innerText="р╣Др╕бр╣Ир╕Юр╕Ър╕Др╕гр╕╣";

    const t = snap.docs[0].data();
    if(t.password === loginPass.value && t.active){
      currentTeacher = snap.docs[0].id;
      show("teacher");
      loadSubjects();
    } else loginMsg.innerText="р╕гр╕лр╕▒р╕кр╕Ьр╕┤р╕Ф";
  }
};

/* ADMIN */
window.changeAdminPass = async ()=>{
  await setDoc(doc(db,"config","admin"),
    {password:newAdminPass.value});
  adminMsg.innerText="р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕гр╕лр╕▒р╕кр╣Бр╕ер╣Йр╕з";
};

window.addTeacher = async ()=>{
  await addDoc(collection(db,"teachers"),{
    name:teacherName.value,
    password:teacherPass.value,
    active:true
  });
  adminMsg.innerText="р╣Ар╕Юр╕┤р╣Ир╕бр╕Др╕гр╕╣р╣Бр╕ер╣Йр╕з";
};

window.addSubject = async ()=>{
  await addDoc(collection(db,"subjects"),{
    name:subjectName.value,
    active:true
  });
  adminMsg.innerText="р╣Ар╕Юр╕┤р╣Ир╕бр╕зр╕┤р╕Кр╕▓р╣Бр╕ер╣Йр╕з";
};

window.openSystem = async ()=>{
  await setDoc(doc(db,"config","system"),{active:true});
};

window.closeSystem = async ()=>{
  await setDoc(doc(db,"config","system"),{active:false});
};

/* TEACHER */
async function loadSubjects(){
  subjectSelect.innerHTML="";
  const snap = await getDocs(collection(db,"subjects"));
  snap.forEach(d=>{
    if(d.data().active){
      const o=document.createElement("option");
      o.value=d.id;
      o.textContent=d.data().name;
      subjectSelect.appendChild(o);
    }
  });
}

window.createQR = async status=>{
  const expireAt=new Date(Date.now()+5*60000);
  const ref=await addDoc(collection(db,"qr_sessions"),{
    teacherId:currentTeacher,
    subjectId:subjectSelect.value,
    status,
    expireAt
  });
  qrResult.innerText=ref.id;
};

window.loadReport = async ()=>{
  report.innerHTML="";
  const q=query(collection(db,"attendance"),
    where("subjectId","==",subjectSelect.value));
  const snap=await getDocs(q);
  snap.forEach(d=>{
    const li=document.createElement("li");
    li.textContent=d.data().studentId+" - "+d.data().status;
    report.appendChild(li);
  });
};

/* STUDENT */
const qr=new Html5Qrcode("reader");
qr.start(
  {facingMode:"environment"},
  {fps:10,qrbox:250},
  async id=>{
    if(!studentId.value) return alert("р╣Гр╕кр╣Ир╕гр╕лр╕▒р╕кр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ");
    const snap=await getDoc(doc(db,"qr_sessions",id));
    if(!snap.exists()) return alert("QR р╕Ьр╕┤р╕Ф");
    if(new Date()>snap.data().expireAt.toDate())
      return alert("р╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕");

    await addDoc(collection(db,"attendance"),{
      studentId:studentId.value,
      subjectId:snap.data().subjectId,
      status:snap.data().status,
      time:new Date()
    });
    studentMsg.innerText="р╣Ар╕Кр╣Зр╕Бр╕Кр╕╖р╣Ир╕нр╣Бр╕ер╣Йр╕з";
    qr.stop();
  }
);
</script>
</body>
</html>
