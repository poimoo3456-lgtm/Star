<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>р╕гр╕░р╕Ър╕Ър╣Ар╕Кр╣Зр╕Бр╕Кр╕╖р╣Ир╕н QR</title>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h2>р╕гр╕░р╕Ър╕Ър╣Ар╕Кр╣Зр╕Бр╕Кр╕╖р╣Ир╕нр╕Фр╣Йр╕зр╕в QR</h2>

<button onclick="show('teacher')">ЁЯСитАНЁЯПл р╕Др╕гр╕╣</button>
<button onclick="show('student')">ЁЯСйтАНЁЯОУ р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ</button>
<button onclick="show('admin')">ЁЯЫа Admin</button>

<hr>

<!-- ================= р╕Др╕гр╕╣ ================= -->
<div id="teacher" style="display:none">
  <h3>р╕гр╕░р╕Ър╕Ър╕Др╕гр╕╣</h3>

  <select id="subject">
    <option value="math">р╕Др╕Ур╕┤р╕Хр╕ир╕▓р╕кр╕Хр╕гр╣М</option>
    <option value="thai">р╕ар╕▓р╕йр╕▓р╣Др╕Чр╕в</option>
  </select><br><br>

  <button onclick="createQR('р╕бр╕▓')">р╕кр╕гр╣Йр╕▓р╕З QR р╣Ар╕Кр╣Зр╕Бр╕Кр╕╖р╣Ир╕н</button>
  <button onclick="createQR('р╕кр╕▓р╕в')">р╣Ар╕Ыр╕┤р╕Фр╕кр╕▓р╕в</button>

  <pre id="qrResult"></pre>
</div>

<!-- ================= р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ ================= -->
<div id="student" style="display:none">
  <h3>р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╣Ар╕Кр╣Зр╕Бр╕Кр╕╖р╣Ир╕н</h3>

  <input id="studentId" placeholder="р╕гр╕лр╕▒р╕кр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ"><br><br>

  <div id="reader" style="width:300px"></div>
  <p id="studentResult"></p>
</div>

<!-- ================= Admin ================= -->
<div id="admin" style="display:none">
  <h3>р╕гр╕░р╕Ър╕Ър╕лр╕ер╕▒р╕Зр╕Ър╣Йр╕▓р╕Щ</h3>
  <button onclick="openSystem()">р╣Ар╕Ыр╕┤р╕Фр╕гр╕░р╕Ър╕Ъ</button>
  <button onclick="closeSystem()">р╕Ыр╕┤р╕Фр╕гр╕░р╕Ър╕Ъ</button>
</div>

<!-- ================= Firebase + Logic ================= -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, addDoc, doc, getDoc, setDoc } from
"https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ---------- Firebase ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyD19ffZKxxXfWj9sseK66LCCVEWqGNqPPI",
  authDomain: "appsk-7f523.firebaseapp.com",
  projectId: "appsk-7f523"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- р╕гр╕░р╕Ър╕Ъ ---------- */
const teacherId = "teacher001";

/* ---------- UI ---------- */
window.show = (id) => {
  ["teacher","student","admin"].forEach(d =>
    document.getElementById(d).style.display = "none"
  );
  document.getElementById(id).style.display = "block";
};

/* ---------- р╕Др╕гр╕╣р╕кр╕гр╣Йр╕▓р╕З QR ---------- */
window.createQR = async (status) => {
  const subjectId = subject.value;
  const expireAt = new Date(Date.now() + 5 * 60000);

  const docRef = await addDoc(collection(db, "qr_sessions"), {
    teacherId,
    subjectId,
    status,
    expireAt,
    active: true
  });

  qrResult.innerText =
    "QR SESSION ID\n\n" + docRef.id;
};

/* ---------- р╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щр╕кр╣Бр╕Бр╕Щ ---------- */
const qr = new Html5Qrcode("reader");

show("student");
qr.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  async (sessionId) => {
    const sid = studentId.value;
    if (!sid) {
      alert("р╕Бр╕гр╕нр╕Бр╕гр╕лр╕▒р╕кр╕Щр╕▒р╕Бр╣Ар╕гр╕╡р╕вр╕Щ");
      return;
    }

    const ref = doc(db, "qr_sessions", sessionId);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      alert("QR р╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З");
      return;
    }

    const data = snap.data();
    if (new Date() > data.expireAt.toDate()) {
      alert("QR р╕лр╕бр╕Фр╕нр╕▓р╕вр╕╕");
      return;
    }

    await addDoc(collection(db, "attendance"), {
      studentId: sid,
      subjectId: data.subjectId,
      status: data.status,
      time: new Date()
    });

    studentResult.innerText =
      "р╣Ар╕Кр╣Зр╕Бр╕Кр╕╖р╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И (" + data.status + ")";
    qr.stop();
  }
);

/* ---------- Admin ---------- */
window.openSystem = async () => {
  await setDoc(doc(db, "config", "system"), { active: true });
  alert("р╣Ар╕Ыр╕┤р╕Фр╕гр╕░р╕Ър╕Ър╣Бр╕ер╣Йр╕з");
};

window.closeSystem = async () => {
  await setDoc(doc(db, "config", "system"), { active: false });
  alert("р╕Ыр╕┤р╕Фр╕гр╕░р╕Ър╕Ър╣Бр╕ер╣Йр╕з");
};
</script>

</body>
</html>
