<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>ระบบเช็กชื่อ QR</title>
<script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h2>ระบบเช็กชื่อเข้าเรียน</h2>

<div id="login">
  <select id="role">
    <option value="student">นักเรียน</option>
    <option value="teacher">ครู</option>
    <option value="admin">หลังบ้าน</option>
  </select><br><br>

  <input id="password" placeholder="รหัสเข้าใช้งาน"><br><br>
  <button onclick="login()">เข้าใช้งาน</button>
</div>

<hr>

<!-- ================= ครู ================= -->
<div id="teacher" style="display:none">
  <h3>ระบบครู</h3>

  <input id="teacherId" placeholder="รหัสครู"><br><br>

  <select id="subject">
    <option value="math">คณิตศาสตร์</option>
    <option value="thai">ภาษาไทย</option>
  </select><br><br>

  <button onclick="createQR('มา')">สร้าง QR เช็กชื่อ</button>
  <button onclick="lateMode()">เปิดสาย</button>

  <pre id="qrResult"></pre>
</div>

<!-- ================= นักเรียน ================= -->
<div id="student" style="display:none">
  <h3>นักเรียน</h3>
  <input id="studentId" placeholder="เลขประจำตัวนักเรียน"><br><br>
  <div id="reader" style="width:300px"></div>
  <p id="studentResult"></p>
</div>

<!-- ================= Admin ================= -->
<div id="admin" style="display:none">
  <h3>ระบบหลังบ้าน</h3>

  <h4>เพิ่มข้อมูล</h4>
  <input id="newName" placeholder="ชื่อ"><br>
  <select id="addType">
    <option value="students">นักเรียน</option>
    <option value="teachers">ครู</option>
    <option value="subjects">วิชา</option>
  </select><br><br>
  <button onclick="addData()">เพิ่ม</button>

  <h4>ควบคุมระบบ</h4>
  <button onclick="setSystem(true)">เปิดระบบ</button>
  <button onclick="setSystem(false)">ปิดระบบ</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, doc, getDoc, setDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD19ffZKxxXfWj9sseK66LCCVEWqGNqPPI",
  authDomain: "appsk-7f523.firebaseapp.com",
  projectId: "appsk-7f523"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allowLate = false;

/* ---------- Login ---------- */
window.login = async () => {
  const role = roleSelect.value;
  const pass = password.value;

  if (role === "admin" && pass === "1669") show("admin");
  else if (role === "teacher" && pass.length > 0) show("teacher");
  else if (role === "student" && pass.length > 0) {
    show("student");
    startScan();
  }
  else alert("รหัสไม่ถูกต้อง");
};

const roleSelect = document.getElementById("role");

/* ---------- UI ---------- */
function show(id) {
  ["login","teacher","student","admin"].forEach(d =>
    document.getElementById(d).style.display = "none"
  );
  document.getElementById(id).style.display = "block";
}

/* ---------- QR ครู ---------- */
window.createQR = async (status) => {
  if (status === "สาย" && !allowLate) {
    alert("ยังไม่เปิดสาย");
    return;
  }

  const expireAt = new Date(Date.now() + 5 * 60000);
  const ref = await addDoc(collection(db,"qr_sessions"), {
    status, expireAt
  });
  qrResult.innerText = "SESSION ID\n\n" + ref.id;
};

window.lateMode = () => {
  allowLate = true;
  alert("เปิดระบบสายแล้ว");
};

/* ---------- นักเรียน ---------- */
let qr;
function startScan() {
  qr = new Html5Qrcode("reader");
  qr.start({facingMode:"environment"}, {fps:10, qrbox:250},
    async (id) => {
      await addDoc(collection(db,"attendance"), {
        studentId: studentId.value,
        sessionId: id,
        time: new Date()
      });
      studentResult.innerText = "เช็กชื่อสำเร็จ";
      qr.stop();
    }
  );
}

/* ---------- Admin ---------- */
window.addData = async () => {
  await addDoc(collection(db, addType.value), {
    name: newName.value
  });
  alert("เพิ่มข้อมูลแล้ว");
};

window.setSystem = async (state) => {
  await setDoc(doc(db,"config","system"), {active: state});
  alert(state ? "เปิดระบบ" : "ปิดระบบ");
};
</script>

</body>
</html>
